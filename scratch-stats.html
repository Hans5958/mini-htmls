---
layout: default
title: Scratch Stats
description: Mini HTMLs
---

<script>
	/*

	This is, really, not a ScratchStats.com clone.
	I wrote this script by myself.

	I actually challenged myself to write this in ES5.
	But, by using ES5 I can make it faster with promises.
	Also, I can make the code cleaner by using ES6.

	@World_Languages, watch and learn. lol

	*/

	// One-time preparations

	const
		buildDate = "04/07/2019",
		corsOverride = false,

		stats = ["views", "loves", "favorites", "comments", "remixes"],
		statsC = ["Views", "Loves", "Favorites", "Comments", "Remixes"],
		statsP = ["viewed", "loved", "favorited", "commented", "remixed"],
		statsPC = ["Viewed", "Loved", "Favorited", "Commented", "Remixed"]

	let username, cors, profileData, proj1, proj2,
		page, pageDone, projDone, projN, projList,
		topProjects, dateJoined, activity, msgCount,
		log = [],
		report = []

	// Log function for interface.

	function logEvent(logged = "", error = false, update = true) {

		//	console.log("[SS] " + logged)
		log.push(logged)
		if (error === true) {
			$("#username")[0].disabled = false
			$("#mode")[0].disabled = false
		}
		if (update === true) {
			$("pre#log")[0].innerHTML = log.join("\n")
			$("pre#log")[0].scrollTop = $("pre#log")[0].scrollHeight;
		}

	}

	// Report function.

	function reportEvent(reported = "") {
		report.push(reported)
	}

	// Timer functions
	const timer = {
		time: 0,
		
		start() {
			return this.time = Date.now() 
		},

		stop() {
			return this.time = Date.now() - this.time
		}
	}

	// Initialization for dynamic execution.

	const init = () => new Promise(async callback => {
		
		logEvent()
		logEvent("Scratch Stats starting...")
		logEvent("Preparing...")

		$("#username")[0].disabled = true
		$("#mode")[0].disabled = true
		timer.start()
		report = []
		proj2 = []
		page = 0
		pageDone = 0
		projDone = 0
		projList = []
		topProjects = {
			"views": {},
			"loves": {},
			"favorites": {},
			"comments": {},
			"remixes": {},
			"oldest": {},
			"newest": {}
		}
		sortLists = {
			"views": {},
			"loves": {},
			"favorites": {},
			"comments": {},
			"remixes": {},
			"id": {}
		}
		totalStats = {
			"views": 0,
			"loves": 0,
			"favorites": 0,
			"comments": 0,
			"remixes": 0
		}
		avgStats = {
			"views": 0,
			"loves": 0,
			"favorites": 0,
			"comments": 0,
			"remixes": 0
		}
		activity = {
			"favorite": 0,
			"love": 0,
			"studioadd": 0,
			"studiofollow": 0,
			"userfollow": 0,
			"studiocurator": 0,
			"studiomanager": 0,
			"share": 0,
			"total": 0
		}

		// Selecting CORS proxy.

		const corsDetect = () => new Promise(callback2 => {
			$.getJSON("https://glen-hydrofoil.glitch.me/https://api.scratch.mit.edu", function() {
					callback2("https://glen-hydrofoil.glitch.me/")
				})
				.fail(function() {
					$.getJSON("https://cors.io/?https://api.scratch.mit.edu", function() {
							callback2("https://cors.io?")
						})
						.fail(function() {
							$.getJSON("https://api.codetabs.com/cors-proxy/https://api.scratch.mit.edu", function() {
									callback2("https://api.codetabs.com/cors-proxy/")
								})
								.fail(function() {
									$.getJSON("https://jsonp.afeld.me/?url=https://api.scratch.mit.edu", function() {
											callback2("https://jsonp.afeld.me/?url=")
										})
										.fail(function() {
											callback2(false)
										})
								})
						})
				})
		})

		logEvent("Selecting CORS proxy...")
		if (typeof corsOverride === "string") {
			cors = corsOverride
			logEvent("CORS proxy selected! " + cors)
			callback()
		} else {
			cors = await corsDetect()
			if (cors) {
				logEvent("CORS proxy selected! " + cors)
				callback()
			} else {
				logEvent("CORS proxy failed! Aborting operation.", true)
			}
		}

	})

	// Obtaining user's data, if failed then such user don't exist.

	const execProfile = () => new Promise(callback => {

		username = $("#username")[0].value
		logEvent("Username: " + username)
		logEvent("Finding user...")
		$.getJSON(cors + "https://api.scratch.mit.edu/users/" + username)
			.done(function(data) {
				logEvent("User found!")
				profileData = data
				dateJoined = new Date(data.history.joined)
				callback()
			})
			.fail(function() {
				logEvent("User not found! Aborting operation.", true)
			})

	})

	// A new method of obtaining project's data with a single API for listing projects.

	const execProjectMain = () => new Promise(callback => {

		logEvent("Retrieving projects list...")

		function gallery(pg) {
			pgPlus = pg + 1
			logEvent("Analyzing page " + pgPlus + "...")
			$.getJSON(cors + "https://api.scratch.mit.edu/users/" + username + "/projects/?limit=40&offset=" + pg * 40,
				function(data) {
					if (data.length != 0) {
						data.forEach(function(v) {
							logEvent(v.id + " " + v.title, false, false)
							projList.push({
								"id": v.id,
								"title": v.title,
								"stats": v.stats
							})
						})
						logEvent("Analyzed page " + pgPlus + ".")
						logEvent("Total projects now: " + projList.length)
						gallery(pgPlus)
					} else {
						logEvent("All pages analyzed and all project's statistics obtained!")
						callback()
					}
				})
		}
		gallery(0)

	})

	// An alternative, old method of obtaining project's data by fetch the lists of projects
	// and fetch the project's data manually.

	const execProjectAlt = () => new Promise(async callback1 => {

		const execProjectList = () => new Promise(callback2 => {
			logEvent("Retrieving projects list...")

			function funcCallback(pageNow) {
				logEvent("Analyzed page " + pageNow + " of " + pageTotal + ".")
				logEvent("Total projects now: " + proj2.length)
				pageDone++
				if (pageDone === pageTotal) {
					console.log(callback2)
					callback2()
				}
			}

			$.get(cors + "https://scratch.mit.edu/users/" + username + "/projects/")
				.done(function(data1) {
					proj1 = data1.match(/project\/\d+/gm)
					proj2 = proj2.concat(proj1)
					if (data1.match(/<span class="page-current/gm) === null) {
						pageTotal = 1
					} else {
						pageTotal = data1.match(/<span class="page-current/gm).length
					}
					logEvent("Projects retrieved!")
					logEvent("Analyzing " + pageTotal + " page(s)...")
					// Starts the analyze process.
					funcCallback(1)
					if (pageTotal > 1) {
						for (var i = 2; i < pageTotal + 1; i++) {
							$.get(cors + "https://scratch.mit.edu/users/" + username + "/projects/?page=" + i, function(data2) {
								proj1 = data2.match(/project\/\d+/gm)
								proj2 = proj2.concat(proj1)
								funcCallback(i)
							})
						}
					}
				})
		})

		const execProjectData = () => new Promise(callback2 => {
			logEvent("All pages analyzed!")
			logEvent("Total projects: " + proj2.length)
			projN = proj2.length
			logEvent("Obtaining " + projN + " project's statistics...")
			for (var i2 = 0; i2 < projN + 1; i2++) {
				$.getJSON(cors + "https://api.scratch.mit.edu/projects/" + proj2[i2].match(/\d+/g))
					.done(function(data) {
						projDone++
						logEvent("Obtained project's statistics " + projDone + " of " + projN + ".")
						logEvent(data.id + " " + data.title)
						projList.push({
							"id": data.id,
							"title": data.title,
							"stats": data.stats
						})
						if (projN == projDone) {
							logEvent("All project's statistics obtained!")
							callback1()
						}
					})
					.fail(function() {
						projDone++
						logEvent("Failed to obtain project's statistics " + projDone + " of " + projN + ".")
						logEvent(data.id)
						if (projN == projDone) {
							logEvent("All project's statistics obtained!")
							callback1()
						}
					})
			}
		})

		await execProjectList()
		await execProjectData()

	})

	// Analyzing the project's for its stats.

	const execProjectStats = () => new Promise(callback => {

		logEvent("Analyzing all projects...")

		stats.forEach(function(v1) {
			sortLists[v1] = Array.from(projList)
			sortLists[v1].sort(function(a, b) {
				return b.stats[v1] - a.stats[v1];
			})
			topProjects[v1] = sortLists[v1][0]
			projList.forEach(function(v2) {
				totalStats[v1] += v2.stats[v1]
			})
			avgStats[v1] = Math.round(totalStats[v1] / projList.length)
		})
		sortLists.id = Array.from(projList)
		sortLists.id.sort(function(a, b) {
			return a.stats.id + b.stats.id;
		})
		topProjects.id = sortLists.id[0]
		projList.forEach(function(v2) {
			totalStats.id += v2.stats.id
		})
		avgStats.id = Math.round(totalStats.id / projList.length)
		topProjects.oldest = sortLists.id[0]
		topProjects.newest = sortLists.id[projList.length - 1]
		logEvent("All projects analyzed!")
		callback()

	})

	// Obtaining user activity.
	const execActivity = () => new Promise(callback => {
		
		logEvent("Analyzing user activity...")
		$.get(cors + "https://scratch.mit.edu/messages/ajax/user-activity/?user=" + username + "&max=99999", function(
			data) {
			function actMatch(regex) {
				return (data.match(regex) === null) ? 0 : data.match(regex).length
			}
			activity.favorite = actMatch(/favorites/g)
			activity.love = actMatch(/loves/g)
			activity.studioadd = actMatch(/added/g)
			activity.studiofollow = actMatch(/following the/g)
			activity.userfollow = actMatch(/following (?!the)/g)
			activity.studiocurator = actMatch(/became/g)
			activity.studiomanager = actMatch(/promoted/g)
			activity.share = actMatch(/shared/g)
			activity.total = actMatch(/\/li/g)
			logEvent("User activity analyzed!")
			callback()
		})

	})

	// Obtaining message count of a user.
	// Let's be honest, it is useless but novelty.

	const execMessages = () => new Promise(callback => {

		logEvent("Obtaining message count...")
		$.getJSON(cors + "https://api.scratch.mit.edu/users/" + username + "/messages/count", function(data) {
			msgCount = data.count
			logEvent("Message count obtained!")
			callback()
		})

	})

	// End of the execution. Print the report.

	function execEnd() {

		// Making the report first on an array, maybe I can implement
		// features like saving your report, some time later.

		// Header

		reportEvent("Hans5958's Scratch Stats (build date " + buildDate + ")")
		reportEvent("Report of " + profileData.username)
		reportEvent()
		reportEvent("Data obtained on " + moment().tz(moment.tz.guess()).format("dddd, D MMMM YYYY, H:mm:ss z") + ".")
		reportEvent("Vanity URL: " + window.location)
		reportEvent()

		// General info.

		reportEvent("Username: " + profileData.username)
		reportEvent("ID: " + profileData.id)
		reportEvent("Join Date: " + moment.tz(dateJoined, "GMT").tz(moment.tz.guess()).format("dddd, D MMMM YYYY, H:mm:ss z"))
		reportEvent("Country: " + profileData.profile.country)
		reportEvent("Projects Shared: " + proj2.length)
		reportEvent("Current Message Count: " + msgCount)
		reportEvent()

		// User activity.

		reportEvent("User Activity (each limited to 20)")
		reportEvent("Projects Loved: " + activity.love)
		reportEvent("Projects Favorited: " + activity.favorite)
		reportEvent("Projects Shared: " + activity.share)
		reportEvent("Users Followed: " + activity.userfollow)
		reportEvent("Projects Added to Studio: " + activity.studioadd)
		reportEvent("Studios Curated: " + activity.studiocurator)
		reportEvent("Studios Managed: " + activity.studiomanager)
		reportEvent("Total: " + activity.total)
		reportEvent()

		// Project stats.

		stats.forEach(function(v, i) {
			reportEvent("Total " + statsC[i] + ": " + totalStats[v])
		})
		reportEvent()
		stats.forEach(function(v, i) {
			reportEvent("Average " + statsC[i] + ": " + avgStats[v])
		})
		reportEvent()
		stats.forEach(function(v, i) {
			reportEvent("Most " + statsPC[i] + " Project: " + topProjects[v].title + " (" + topProjects[v].stats[v] + ")")
		})
		reportEvent()
		reportEvent("Oldest Project: " + topProjects.oldest.title + " (" + topProjects.oldest.id + ")")
		reportEvent("Newest Project: " + topProjects.newest.title + " (" + topProjects.newest.id + ")")
		reportEvent()

		// List of stats.

		reportEvent("Lists Of Stats:")
		reportEvent()
		reportEvent("Projects: (views / loves / comments / favorites / remixes)")
		sortLists.id.forEach(function(v, i) {
			i++
			reportEvent(i + ". [" + v.id + "] " + v.title + " (" + v.stats.views + " / " + v.stats.loves + " / " + v.stats
				.comments +
				" / " + v.stats.favorites + " / " + v.stats.remixes + ")")
		})
		stats.forEach(function(v1, i) {
			reportEvent()
			reportEvent("Most " + statsPC[i] + " Project:")
			sortLists[v1].forEach(function(v2, i) {
				i++
				reportEvent(i + ". [" + v2.stats[v1] + "] " + v2.title)
			})
		})

		// Priting the actual report.

		logEvent()
		logEvent("================================")
		logEvent()
		report.forEach(function(v) {
			logEvent(v, false, false)
		})
		logEvent()
		logEvent("================================")
		logEvent()
		logEvent("Report printed!")
		logEvent("Operation completed in " + timer.stop() / 1000 + " seconds.", true)

	}

	// Execution triggers, including from vanity URL and edge cases.

	$(function() {
		
		$("input")[0].value = (window.location.hash) ? window.location.hash.slice(1) : "Hans5958"
		window.location.hash = $("input")[0].value
		go()
		$("#username").change(function() {
			go()
			window.location.hash = $("input")[0].value
			$("input")[0].value = window.location.hash.slice(1)
		})
		window.onhashchange = function() {
			go()
			$("input")[0].value = window.location.hash.slice(1)
			window.location.hash = $("input")[0].value
		}
		$("#mode").change(function() {
			go()
		})

	})

	// The execution!

	async function go() {

		if ($("#username")[0].disabled === false) {
			async function execProject() {
				if ($("#mode")[0].value === "main") {
					await execProjectMain()
				} else {
					await execProjectAlt()
				}
				await execProjectStats()
			}
			await init()
			await execProfile()
			await Promise.all([execActivity(), execMessages(), execProject()])
			execEnd()
		}

	}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.25/moment-timezone-with-data-10-year-range.js">
</script>

<div class="container">
	<div class="row">
		<div class="form-group col-md-6">
			<label for="username">Username:</label>
			<input type="text" class="form-control" id="username" placeholder="Username" value="Hans5958">
		</div>
		<div class="form-group col-md-6">
			<label for="mode">Mode for Fetching Projects:</label>
			<select class="form-control" id="mode">
				<option value="main">Main (faster, no remix count)</option>
				<option value="alt">Alternative (slower, bug-free)</option>
			</select>
		</div>
	</div>
	<div class="row">
		<!--
	<div id="username">
		<h2>Username</h2>
		<p></p>
	</div>
	<div id="userid">
		<h2>ID</h2>
		<p></p>
	</div>
	<div id="joindate">
		<h2>Date Joined</h2>
		<p></p>
	</div>
	<div id="country">
		<h2>Country</h2>
		<p></p>
	-->
		<pre id="log" style="height:calc(100vh - 250px);width:100%;overflow:auto"></pre>
	</div>
</div>