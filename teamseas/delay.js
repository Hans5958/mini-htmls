dayjs.extend(window.dayjs_plugin_utc);let timer,cors,currentCount=0,delayCount=0,diffAvg=0,diffReal=0,diffdelay=0,initTimer=()=>Math.round(10*(63-new Date%6e4/1e3-4*Math.random()+2)),diffArray=[],parser=new DOMParser,queueInfo=[],queueAmount={},queueCallback={};const digestMessage=async e=>{const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")},corsDetect=()=>new Promise(e=>{$.get("https://tscache.com/donation_total.json").done(function(){e("")}).fail(function(){$.get("https://cf-cors.hans5958.workers.dev/?url=https://tscache.com/donation_total.json").done(function(){e("https://cf-cors.hans5958.workers.dev/?url=")}).fail(function(){e(!1)})})}),getData=async(e,t,n)=>{return await fetch(cors+e)["catch"](n)},updateMargin=()=>{document.querySelector("#main p").textContent=currentCount+delayCount,document.querySelector("#diff p").textContent=diffdelay,document.querySelector("#diffReal p").textContent=diffReal},updateDiff=(e,t)=>{if(!isNaN(e))return t.push(e),t.length>11&&t.shift(),Math.round(10*sumArray(t)/t.length)},updateStats=async e=>{let t=e.recent;for(let e in t){let n=t[e],a=n.name,o=Number(n.pounds.replace(/,/g,"")),r=dayjs(1e3*n.created_at),u=await digestMessage(JSON.stringify(n)).then(e=>e);await addRecent(a,o,r,u)}},addRecent=async(e,t,n,a)=>{let o=dayjs().subtract("2","minutes");if(o>n)return;if(console.log(queueInfo.includes(a)),queueInfo.includes(a))return;delayCount-=t,queueInfo.unshift(a);let r=document.createElement("tr"),u=document.createElement("td"),d=document.createElement("td"),c=document.createElement("td");u.innerHTML=e,d.innerHTML="$"+t,c.innerHTML=dayjs(n).format("D/M/YYYY, H:mm:ss"),r.appendChild(u),r.appendChild(d),r.appendChild(c);let i=document.querySelector("#recentDonations"),s=Math.floor(n/1e3);queueAmount[s]||(queueAmount[s]=0),queueAmount[s]+=t;let l=n-o;clearInterval(queueCallback[a]),queueCallback[a]=setTimeout(()=>{let e=dayjs().subtract("2","minutes");for(;i.children.length>4;)i.removeChild(i.lastChild);i.prepend(r),queueAmount[Math.floor(e/1e3)]&&(delayCount+=queueAmount[Math.floor(e/1e3)],delete queueAmount[Math.floor(e/1e3)]),diffdelay+=t,setTimeout(()=>{queueInfo.shift(),diffdelay-=t},6e4)},l)},sumArray=e=>e.reduce((e,t)=>e+t),afterGet=async e=>{let t=Number(e.total.count);currentCount&&(diffAvg=updateDiff(t-currentCount,diffArray),diffReal=t-currentCount),currentCount=t,await updateStats(e.lb)},reload=async()=>{let e=await(await getData("https://tscache.com/lb_recent.json")).json(),t=await(await getData("https://tscache.com/donation_total.json")).json();console.log(delayCount),await afterGet({lb:e,total:t})};$(async()=>{let e=dayjs.utc("2022-01-01 00:00");$("#countdown").countdown(e.toDate(),function(e){$(this).html(e.strftime("%D:%H:%M:%S"))}),cors=await corsDetect(),setInterval(async()=>{timer--,$("#update").html("Update: "+timer/10+"s"),Math.round(timer)===timer&&(updateMargin(),document.querySelector("#delay-time").textContent=dayjs().subtract("2","minutes").format("H:mm:ss")),timer||(timer=initTimer(),reload())},100)});